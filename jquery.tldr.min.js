(function(e){e.fn.tldr=function(f){var g=e.extend({},e.fn.tldr.defaults,f);return this.each(function(){$this=e(this);output=e.fn.tldr.build($this,g);if(output){if(g.insertAfterLead){output.insertBefore(e(g.headlineElements,g.target).first())}else{output.prependTo(e(g.target===""?$this:g.target))}}})};function b(f){return f.replace(/^\s*/,"").replace(/\s*$/,"").replace(/\n+/," ")}function a(h,f){h=b(h);var g=h.match(/\w.+?[\?\.\!]/g);if(g&&g.length>0){if(f===0){return g.join(" ")}else{return g.slice(0,f).join(" ")}}else{return h}}function c(f){return f.substring(0,f.lastIndexOf(" ")).replace(/[\?\!\.,;:-]$/,"")+"&hellip;"}function d(f){if(!/^<.*>$/.test(f)){return"<"+f+">"}else{return f}}e.fn.tldr.build=function(h,f){var l=h,i=[],g=e(d(f.wrapper)),j=e(/(ol|ul)/.test(f.listType)?d(f.listType):"<ol>"),m=e(d(f.headerTag)).html(f.headerTitle),k=l.find(f.headlineElements);if(f.minimumHeadlines>0&&k.length<f.minimumHeadlines){return false}k.each(function(r,q){var u="",t;if(e(q).data(f.dataAttribute)){u=e(q).data(f.dataAttribute);if(f.maxSummaryLength>0){u=u.substring(0,f.maxSummaryLength)}}else{var w=e(q).nextUntil(f.headlineElements),v=0;if(f.grafsInSummary>0){w=w.slice(0,f.grafsInSummary)}if(w&&w.length>0){for(p=0;p<w.length;p++){var x=a(e(w[p]).text(),f.sentencesPerGraf),s=p>0?"[&hellip;]":"";if(f.maxSummaryLength>0){if(v+x.length<f.maxSummaryLength){u+="<p>"+s+x+"</p> ";v+=x.length}else{x=c(x.substring(0,f.maxSummaryLength-v));if(x.length>35){u+="<p>"+s+x+"</p> "}break}}else{u+="<p>"+x+"</p> "}}}}if(e(q).attr("id")){t="#"+e(q).attr("id")}else{var o=e(q).text().replace(/[^a-z]/gi,"");e(q).attr("id",o);t="#"+o}i.push({target:t,title:e(q).text(),summary:u})});e(i).each(function(q,s){var o=e(d(f.headlineTag)).text(s.title).addClass("tldr-headline");if(f.collapsed&&f.addClickHandler){o.css("cursor","pointer").click(function(u){if(u.target.tagName==="A"){return true}u.preventDefault();if(f.accordion){e(this).closest("ul,ol").find(".summary").slideUp()}var t=e(this).next(".summary");if(t.is(":visible")){t.slideUp()}else{t.slideDown()}});o.append(e("<a>").attr("href",s.target).html(" &rarr;"));var r=e("<div class=summary>").html(s.summary).css({display:"none"});j.append(e("<li>").append(o).append(r))}else{var r=e("<div class=summary>").html(s.summary);j.append(e("<li>").append(o).append(r));o.wrap('<a href="'+s.target+'" />')}});if(f.useMetaDescription&&e("meta[property$=description]").length>0){var n=c(e("meta[property$=description]").attr("content"));j.prepend(e("<li>").html(n))}return g.append(m).append(j)};e.fn.tldr.defaults={headlineElements:"h2,h3",target:"",wrapper:"<div id=tldr-wrapper>",listType:"ol",headlineTag:"strong",headerTag:"h4",headerTitle:"TL;DR",dataAttribute:"tldr",collapsed:false,addClickHandler:true,accordion:true,insertAfterLead:false,grafsInSummary:1,sentencesPerGraf:1,maxSummaryLength:200,minimumHeadlines:3,useMetaDescription:true}})(jQuery);